<!DOCTYPE html>
<html>

<head>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
    html {
        padding: 0px;
        margin: 0px;
        background-color: rgb(235, 232, 226);
        font-family: monospace;
        text-align: center;
    }
    .axis path,
    .axis line {
        fill: none;
        stroke: #000;
        shape-rendering: crispEdges;
        }

    .tooltip {
        position: absolute;
        background-color: rgba(0, 0, 0, 0.8);
        color: #fff;
        padding: 5px 10px;
        border-radius: 3px;
        pointer-events: none;
        opacity: 0;
        }
    .text-container {
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        text-align: left;
        }
    </style>
</head>

<body>
    <div class="text-container">
        <h1>Pride and Prejudice: A Sentiment Analysis</h1>
        <p>
            Welcome to our data visualization project on Pride and Prejudice, the classic novel by Jane Austen. Using
            sentiment analysis, we have calculated the sentiment score for each chapter, providing a unique perspective on
            the emotional journey of the story.
        </p>
    </div>
        
    <script>
        
        const margin = { top: 20, right: 20, bottom: 30, left: 50 },
            width = 660 - margin.left - margin.right,
            height = 500 - margin.top - margin.bottom;

        const x = d3.scaleLinear().range([0, width]);
        const y = d3.scaleLinear().range([height, 0]);

        const xAxis = d3.axisBottom(x);
        const yAxis = d3.axisLeft(y);

        const line = d3
            .line()
            .x((d) => x(d.chapter))
            .y((d) => y(d.sentiment_score));

        const svg = d3
            .select("body")
            .append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform", `translate(${margin.left},${margin.top})`);

        // Add tooltip element
        const tooltip = d3
            .select("body")
            .append("div")
            .attr("class", "tooltip");

        let events = [];

        d3.json("chapter_events.json").then((data) => {
            events = data;
        });

        const colorScale = d3.scaleLinear()
            .domain([0.05, 0.45])
            .range(["blue", "red"]);

        svg.append("rect")
            .attr("width", width)
            .attr("height", height)
            .attr("fill", "url(#sentimentGradient)");

        const sentimentGradient = svg.append("defs")
            .append("linearGradient")
            .attr("id", "sentimentGradient")
            .attr("x1", "0%")
            .attr("y1", "0%")
            .attr("x2", "0%")
            .attr("y2", "100%");

        sentimentGradient
            .append("stop")
            .attr("offset", "0%")
            .attr("stop-color", "#E06469") // Change this color for a more appealing purple
            .attr("stop-opacity", 1);

        sentimentGradient
            .append("stop")
            .attr("offset", "100%")
            .attr("stop-color", "#E3F2C1") // Change this color for a more appealing green
            .attr("stop-opacity", 1);

        d3.csv("sentiment_per_chapter.csv").then((data) => {
            x.domain(d3.extent(data, (d) => +d.chapter));
            y.domain(d3.extent(data, (d) => +d.sentiment_score));

        svg
            .append("g")
            .attr("class", "x axis")
            .attr("transform", `translate(0,${height})`)
            .call(xAxis);

        svg.append("g").attr("class", "y axis").call(yAxis);

        svg
            .append("path")
            .datum(data)
            .attr("class", "line")
            .attr("d", line)
            .attr("fill", "none")
            .attr("stroke", "steelblue")
            .attr("stroke-width", 1.5);
                const localExtrema = data.filter((d, i, arr) => {
            if (i === 0 || i === arr.length - 1) return false;
            const prev = +arr[i - 1].sentiment_score;
            const curr = +d.sentiment_score;
            const next = +arr[i + 1].sentiment_score;
            return (curr > prev && curr > next) || (curr < prev && curr < next);
        });

        svg
            .selectAll(".circle")
            .data(localExtrema)
            .enter()
            .append("circle")
            .attr("class", "circle")
            .attr("cx", (d) => x(+d.chapter))
            .attr("cy", (d) => y(+d.sentiment_score))
            .attr("r", 3)
            .attr("fill", "#617A55")
            .on("mouseover", function (event, d) {
                const eventText = events.find((e) => e.chapter === +d.chapter)?.event || "";
                tooltip
                    .style("opacity", 1)
                    .html(
                        `Chapter: ${d.chapter}<br>Sentiment Score: ${d.sentiment_score}<br>Event: ${eventText}`
                    )
                    .style("left", `${event.pageX + 10}px`)
                    .style("top", `${event.pageY + 10}px`);
            })
            .on("mouseout", function () {
                tooltip.style("opacity", 0);
            });
        });

        const legendWidth = 20;
        const legendHeight = 200;

        const legendSvg = d3
            .select("body")
            .append("svg")
            .attr("width", legendWidth)
            .attr("height", legendHeight);

        const legend = legendSvg
            .append("g")
            .attr("class", "legend")
            .attr("transform", "translate(0, 10)");

        legend
            .append("rect")
            .attr("width", legendWidth)
            .attr("height", legendHeight - 20)
            .style("fill", "url(#sentimentGradient)");

        const legendScale = d3
            .scaleLinear()
            .range([legendHeight - 20, 0])
            .domain([0.05, 0.45]);

        const legendAxis = d3.axisRight(legendScale).ticks(5);

        legend
            .append("g")
            .attr("class", "axis")
            .attr("transform", `translate(${legendWidth}, 0)`)
            .call(legendAxis);
    
        
    </script>           

</body>

</html>